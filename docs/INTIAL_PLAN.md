# Архитектурный план системы напоминаний о лекарствах

## Концептуальная основа

**Event-Driven Architecture (Событийно-ориентированная архитектура)** — паттерн проектирования, где компоненты системы взаимодействуют через события. В нашем случае это критично для точного планирования напоминаний о лекарствах.

**Telegram Bot API (Интерфейс Программирования Приложений Telegram-ботов)** — REST API для создания ботов в мессенджере Telegram. Предоставляет методы для отправки сообщений, обработки команд и callback-запросов.

## Архитектурные компоненты

### 1. Основная архитектура системы

```
┌─────────────────────────────────────────────────────────┐
│                  TELEGRAM BOT                           │
│  ┌─────────────────┐    ┌─────────────────┐             │
│  │  Command        │    │  Callback       │             │
│  │  Handlers       │    │  Handlers       │             │
│  └─────────────────┘    └─────────────────┘             │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│               CORE BUSINESS LOGIC                       │
│  ┌─────────────────┐    ┌─────────────────┐             │
│  │  Schedule       │    │  Quote          │             │
│  │  Manager        │    │  Manager        │             │
│  └─────────────────┘    └─────────────────┘             │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│              PERSISTENCE LAYER                          │
│  ┌─────────────────┐    ┌─────────────────┐             │
│  │  SQLite         │    │  File System    │             │
│  │  Database       │    │  (Quotes)       │             │
│  └─────────────────┘    └─────────────────┘             │
└─────────────────────────────────────────────────────────┘
```

### 2. Модульная структура проекта

```
tabex_bot/
├── main.py                 # Точка входа приложения
├── config/
│   ├── __init__.py
│   ├── settings.py         # Конфигурация приложения
│   └── tabex_phases.py # Схемы приёма лекарств
├── core/
│   ├── __init__.py
│   ├── bot.py             # Инициализация Telegram бота
│   ├── handlers/
│   │   ├── __init__.py
│   │   ├── commands.py    # Обработчики команд
│   │   └── callbacks.py   # Обработчики callback-запросов
│   ├── services/
│   │   ├── __init__.py
│   │   ├── schedule_service.py  # Управление расписанием
│   │   ├── reminder_service.py  # Сервис напоминаний
│   │   └── quote_service.py     # Управление цитатами
│   └── models/
│       ├── __init__.py
│       ├── user.py        # Модель пользователя
│       ├── treatment.py   # Модель курса лечения
│       └── tabex_log.py # Модель записи о приёме
├── database/
│   ├── __init__.py
│   ├── connection.py      # Подключение к БД
│   ├── migrations.py      # Миграции схемы БД
│   └── repositories/
│       ├── __init__.py
│       ├── user_repository.py
│       ├── treatment_repository.py
│       └── tabex_repository.py
├── data/
│   ├── pratchett_quotes.json  # Цитаты Терри Пратчетта
│   └── tabex_bot.db      # SQLite база данных
├── utils/
│   ├── __init__.py
│   ├── datetime_helpers.py    # Помощники для работы с датами
│   ├── text_formatting.py     # Форматирование текста
│   └── validators.py          # Валидация данных
├── requirements.txt
├── .env                       # Переменные окружения
└── README.md
```

## Детальное описание компонентов

### 1. Telegram Bot Layer (Слой Telegram-бота)

**Назначение**: Обработка входящих сообщений и команд от пользователей.

**Ключевые компоненты**:
- **Command Handlers** — обработчики команд типа `/start`, `/help`, `/new_course`
- **Callback Handlers** — обработчики нажатий на inline-кнопки
- **Message Handlers** — обработчики текстовых сообщений

### 2. Core Business Logic (Основная бизнес-логика)

**Schedule Manager** — центральный компонент для управления расписаниями приёма лекарств:
- Расчёт времени следующего приёма на основе фазы лечения
- Управление переходами между фазами
- Обработка пропущенных приёмов

**Quote Manager** — управление цитатами Терри Пратчетта:
- Загрузка цитат из файла
- Выбор контекстуально-подходящих цитат
- Категоризация по типам (мотивация, напоминание, поощрение)

### 3. Persistence Layer (Слой персистентности)

**SQLite Database** — основное хранилище данных:
- Информация о пользователях
- Курсы лечения
- Логи приёма лекарств
- Настройки пользователей

**File System** — файловое хранилище:
- JSON-файл с цитатами Терри Пратчетта
- Логи приложения
- Резервные копии базы данных

## Схема базы данных

### Основные таблицы

1. **users** — пользователи системы
2. **treatment_courses** — курсы лечения
3. **tabex_logs** — записи о приёме лекарств
4. **user_settings** — персональные настройки

### Связи между таблицами

```
users (1) ──→ (N) treatment_courses
treatment_courses (1) ──→ (N) tabex_logs
users (1) ──→ (1) user_settings
```

## Пошаговый план реализации

### Этап 1: Подготовка инфраструктуры (30 минут)

**Задачи**:
1. Создание структуры проекта согласно архитектуре
2. Настройка виртуального окружения Python
3. Установка зависимостей (python-telegram-bot, aiosqlite)
4. Создание файла конфигурации с токеном бота
5. Инициализация Git-репозитория

**Результат**: Готовая структура проекта с настроенным окружением.

### Этап 2: Базовая инфраструктура бота (45 минут)

**Задачи**:
1. Создание основного класса бота в `core/bot.py`
2. Реализация базовых обработчиков команд (`/start`, `/help`)
3. Настройка логирования приложения
4. Создание простейшего main.py для запуска бота
5. Тестирование подключения к Telegram API

**Результат**: Работающий бот, который отвечает на базовые команды.

### Этап 3: База данных и модели данных (60 минут)

**Задачи**:
1. Создание схемы SQLite базы данных
2. Реализация классов-моделей (User, Treatment, tabexLog)
3. Создание репозиториев для работы с данными
4. Реализация миграций базы данных
5. Создание методов для CRUD операций

**Результат**: Полнофункциональная система работы с данными.

### Этап 4: Система расписаний (90 минут)

**Задачи**:
1. Реализация ScheduleService для расчёта времени приёма
2. Создание алгоритма определения текущей фазы лечения
3. Реализация ReminderService для отправки напоминаний
4. Создание системы asyncio-планировщика для точных уведомлений
5. Обработка пропущенных приёмов и пауз в лечении

**Результат**: Работающая система точных напоминаний о приёме лекарств.

### Этап 5: Пользовательский интерфейс (75 минут)

**Задачи**:
1. Создание команды `/new_course` для начала нового курса лечения
2. Реализация inline-клавиатур для подтверждения приёма
3. Создание команд `/status`, `/pause`, `/resume`
4. Реализация настроек пользователя
5. Добавление команды `/stats` для статистики приёма

**Результат**: Полный пользовательский интерфейс для управления лечением.

### Этап 6: Интеграция цитат Терри Пратчетта (45 минут)

**Задачи**:
1. Создание JSON-файла с цитатами и их категоризация
2. Реализация QuoteService для управления цитатами
3. Интеграция цитат в напоминания и подтверждения
4. Создание системы контекстуального выбора цитат
5. Добавление команды `/quote` для получения случайной цитаты

**Результат**: Система мотивационных цитат, интегрированная в процесс лечения.

### Этап 7: Локализация и полировка (30 минут)

**Задачи**:
1. Полный перевод всех сообщений на русский язык
2. Форматирование времени в российском формате
3. Настройка часовых поясов
4. Создание дружелюбных сообщений об ошибках
5. Финальное тестирование всех функций

**Результат**: Полностью локализованный и готовый к использованию бот.

### Этап 8: Деплой и мониторинг (15 минут)

**Задачи**:
1. Создание скрипта для автозапуска бота
2. Настройка Windows Service или Task Scheduler
3. Создание простой системы мониторинга работы бота
4. Настройка ротации логов
5. Создание скрипта резервного копирования базы данных

**Результат**: Автономно работающий бот на production-сервере.

## Технические детали реализации

### Система планирования напоминаний

**Алгоритм расчёта времени приёма**:
1. Определение текущей фазы лечения по дате начала курса
2. Расчёт интервала между приёмами для текущей фазы
3. Планирование следующего напоминания с учётом часовых поясов
4. Обработка переходов между фазами в режиме реального времени

### Обработка ошибок и отказоустойчивость

**Критические сценарии**:
- Потеря соединения с Telegram API
- Недоступность базы данных
- Системные сбои во время критических напоминаний
- Некорректные пользовательские данные

**Стратегии восстановления**:
- Автоматический retry для API-запросов
- Локальное кэширование критических данных
- Система аварийных уведомлений
- Graceful degradation при частичных сбоях

Данная архитектура обеспечивает надёжную работу системы при минимальной сложности реализации, что идеально подходит для персонального проекта с двумя пользователями.