# Архитектурный план системы напоминаний "Табекс-Бот" в мире Плоского мира

## Концептуальная основа

**Сюжетная канва**: Пользователь попадает в руки Городской Стражи Анк-Морпорка по подозрению в курении табака. Ему предлагается программа исправления "Табекс" как альтернатива тюрьме. Проходя 25-дневный курс под надзором различных персонажей стражи, пользователь постепенно "исправляется" и в конце получает аудиенцию у самого Лорда Витинари.

**Event-Driven Architecture с элементами Role-Playing Game** — система, где каждый этап лечения представлен взаимодействием с определенным персонажем Плоского мира. События (прием таблеток, переходы между фазами) управляют нарративом и прогрессией пользователя.

**Character-Based Interaction System** — каждый персонаж имеет уникальный стиль речи и реакции, включая гендерно-зависимое поведение.

## Архитектурные компоненты

### 1. Основная архитектура системы

```
┌─────────────────────────────────────────────────────────┐
│                  TELEGRAM BOT LAYER                     │
│  ┌─────────────────┐    ┌─────────────────┐             │
│  │  Command        │    │  Callback       │             │
│  │  Handlers       │    │  Handlers       │             │
│  └─────────────────┘    └─────────────────┘             │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│            CHARACTER INTERACTION LAYER                  │
│  ┌─────────────────┐    ┌─────────────────┐             │
│  │  Character      │    │  Gender-Based   │             │
│  │  Manager        │    │  Text Manager   │             │
│  └─────────────────┘    └─────────────────┘             │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│               CORE BUSINESS LOGIC                       │
│  ┌─────────────────┐    ┌─────────────────┐             │
│  │  Treatment      │    │  Schedule       │             │
│  │  Phase Manager  │    │  Service        │             │
│  └─────────────────┘    └─────────────────┘             │
│  ┌─────────────────┐    ┌─────────────────┐             │
│  │  Reminder       │    │  Quote          │             │
│  │  Service        │    │  Service        │             │
│  └─────────────────┘    └─────────────────┘             │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│              PERSISTENCE LAYER                          │
│  ┌─────────────────┐    ┌─────────────────┐             │
│  │  SQLite         │    │  File System    │             │
│  │  Database       │    │  (Quotes/Chars) │             │
│  └─────────────────┘    └─────────────────┘             │
└─────────────────────────────────────────────────────────┘
```

### 2. Система персонажей и фаз лечения

```
ДЕНЬ 1-3: Арест и первичный допрос
┌─────────────────────────────────────────┐
│  👮‍♂️ ГАСПОД: "Рррр, попался, гражданин!" │
│  Приводит к Шнобби и Колону             │
│  📋 1 таблетка каждые 2 часа (6 в день)  │
└─────────────────────────────────────────┘

ДЕНЬ 4-12: Надзор стражников
┌─────────────────────────────────────────┐
│  🥔 ШНОББИ: "Ну чё, исправляемся?"       │
│  🪖 КОЛОН: "В армии дисциплина строже!"  │
│  📋 1 таблетка каждые 2.5ч (5 в день)    │
│  ⚠️  ДЕНЬ 5: Полный отказ от курения!    │
└─────────────────────────────────────────┘

ДЕНЬ 13-16: Продвинутый надзор
┌─────────────────────────────────────────┐
│  🐺 АНГВА: "Gut! Прогресс есть!"         │
│  📋 1 таблетка каждые 3 часа (4 в день)  │
└─────────────────────────────────────────┘

ДЕНЬ 17-20: Капитанский контроль
┌─────────────────────────────────────────┐
│  🛡️ МОРКОУ: "Честь и справедливость!"    │
│  📋 1 таблетка каждые 5 часов (3 в день) │
└─────────────────────────────────────────┘

ДЕНЬ 21-25: Командорский надзор
┌─────────────────────────────────────────┐
│  🚬 ВАЙМС: "Почти дошёл до финиша..."    │
│  📋 1-2 таблетки в день                  │
└─────────────────────────────────────────┘

ФИНАЛ: Аудиенция у Патриция
┌─────────────────────────────────────────┐
│  👑 ВИТИНАРИ: "Всё было... проверкой"    │
│  🎯 Раскрытие истинной цели программы    │
└─────────────────────────────────────────┘

СЦЕНАРИЙ НЕУДАЧИ:
┌─────────────────────────────────────────┐
│  💀 СМЕРТЬ: "ВРЕМЯ ВЫШЛО, КУРИЛЬЩИК"     │
│  ❌ Возврат к курению = перезапуск через │
│     2-3 месяца                          │
└─────────────────────────────────────────┘
```

### 3. Модульная структура проекта

```
tabex-bot/
├── main.py                    # Точка входа приложения
├── config/
│   ├── __init__.py
│   ├── settings.py           # Конфигурация приложения
│   └── tabex_phases.py       # Схемы фаз лечения Табекс
├── core/
│   ├── __init__.py
│   ├── bot.py               # Инициализация Telegram бота
│   ├── handlers/
│   │   ├── __init__.py
│   │   ├── commands.py      # Обработчики команд
│   │   └── callbacks.py     # Обработчики callback-запросов
│   ├── services/
│   │   ├── __init__.py
│   │   ├── character_service.py   # Управление персонажами
│   │   ├── schedule_service.py    # Управление расписанием
│   │   ├── reminder_service.py    # Сервис напоминаний
│   │   └── quote_service.py       # Управление цитатами Пратчетта
│   ├── models/
│   │   ├── __init__.py
│   │   ├── user.py          # Модель пользователя (с гендером)
│   │   ├── treatment.py     # Модель курса лечения
│   │   └── tabex_log.py     # Модель записи о приёме
│   └── characters/
│       ├── __init__.py
│       ├── base_character.py      # Базовый класс персонажа
│       ├── gaspode.py            # Гаспод (арест)
│       ├── nobby_colon.py        # Шнобби и Колон (дни 1-12)
│       ├── angua.py              # Ангва (дни 13-16)
│       ├── carrot.py             # Моркоу (дни 17-20)
│       ├── vimes.py              # Ваймс (дни 21-25)
│       ├── vetinari.py           # Витинари (финал)
│       └── death.py              # СМЕРТЬ (неудача)
├── database/
│   ├── __init__.py
│   ├── connection.py        # Подключение к БД
│   ├── migrations.py        # Миграции схемы БД
│   └── repositories/
│       ├── __init__.py
│       ├── user_repository.py
│       ├── treatment_repository.py
│       └── tabex_repository.py
├── data/
│   ├── pratchett_quotes.json    # Цитаты Терри Пратчетта
│   ├── character_texts.json     # Тексты персонажей
│   └── tabex_bot.db            # SQLite база данных
├── utils/
│   ├── __init__.py
│   ├── datetime_helpers.py      # Помощники для работы с датами
│   ├── text_formatting.py       # Форматирование текста
│   └── validators.py            # Валидация данных
├── requirements.txt
├── .env                         # Переменные окружения
└── README.md
```

## Детальное описание компонентов

### 1. Character Interaction Layer (Слой взаимодействия с персонажами)

**Character Manager** — управление персонажами Плоского мира:
- Определение текущего активного персонажа по фазе лечения
- Генерация гендерно-зависимых текстов
- Управление переходами между персонажами

**Персонажи по фазам лечения**:
- **Гаспод** (арест): встречает пользователя, циничен и прямолинеен
- **Шнобби & Колон** (дни 1-12): примитивный и армейский стили общения
- **Ангва** (дни 13-16): прямолинейность с немецким акцентом
- **Моркоу** (дни 17-20): наивная честность и вера в добро
- **Ваймс** (дни 21-25): саркастичный циник с жизненным опытом
- **Витинари** (финал): изощренная вежливость и скрытые смыслы
- **СМЕРТЬ** (неудача): буквальность и архаичные обороты речи

### 2. Treatment Phase System (Система фаз лечения)

**Treatment Phase Manager** — управление медицинскими фазами:
```
Фаза 1 (дни 1-3):   6 таблеток/день, каждые 2 часа
Фаза 2 (дни 4-12):  5 таблеток/день, каждые 2.5 часа + отказ от курения на 5-й день
Фаза 3 (дни 13-16): 4 таблетки/день, каждые 3 часа
Фаза 4 (дни 17-20): 3 таблетки/день, каждые 5 часов
Фаза 5 (дни 21-25): 1-2 таблетки/день, произвольно
```

**Gender-Based Text System** — гендерно-зависимые тексты:
- Мужской пол: стандартные обращения, "классические" реакции персонажей
- Женский пол: модифицированные тексты с учетом гендерных особенностей персонажей

### 3. Core Business Logic (Основная бизнес-логика)

**Schedule Service** — управление расписанием приёма:
- Расчёт времени следующего приёма по активной фазе
- Автоматические переходы между фазами по дням
- Обработка пропущенных приёмов

**Reminder Service** — система напоминаний:
- Персонализированные напоминания от текущего персонажа
- Escalation при пропуске приёма
- Интеграция с системой персонажей

**Quote Service** — управление цитатами Пратчетта:
- Контекстуальный выбор цитат по персонажам
- Категоризация по типам (мотивация, предупреждение, поощрение)
- Гендерно-нейтральная адаптация цитат

### 4. Persistence Layer (Слой персистентности)

**SQLite Database** — основное хранилище:
- Профили пользователей (включая гендер)
- Курсы лечения Табекс с фазами
- Логи приёма таблеток
- История взаимодействий с персонажами

**File System** — конфигурационные данные:
- JSON с цитатами Пратчетта по персонажам
- Шаблоны текстов персонажей (мужские/женские варианты)
- Конфигурация фаз лечения

## Схема базы данных

### Основные таблицы

1. **users** — пользователи системы (с гендером)
2. **treatment_courses** — курсы лечения Табекс
3. **tabex_logs** — записи о приёме таблеток
4. **character_interactions** — история взаимодействий с персонажами

### Детализация таблиц

**users**:
```sql
CREATE TABLE users (
    user_id INTEGER PRIMARY KEY,
    telegram_id INTEGER UNIQUE NOT NULL,
    first_name TEXT NOT NULL,
    username TEXT,
    gender TEXT CHECK(gender IN ('male', 'female')) NOT NULL,
    timezone TEXT DEFAULT 'Europe/Moscow',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**treatment_courses**:
```sql
CREATE TABLE treatment_courses (
    course_id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER REFERENCES users(user_id),
    start_date DATE NOT NULL,
    current_phase INTEGER DEFAULT 1 CHECK(current_phase BETWEEN 1 AND 5),
    current_character TEXT DEFAULT 'gaspode',
    status TEXT DEFAULT 'active' CHECK(status IN ('active', 'completed', 'failed', 'paused')),
    smoking_quit_date DATE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**tabex_logs**:
```sql
CREATE TABLE tabex_logs (
    log_id INTEGER PRIMARY KEY AUTOINCREMENT,
    course_id INTEGER REFERENCES treatment_courses(course_id),
    scheduled_time TIMESTAMP NOT NULL,
    actual_time TIMESTAMP,
    status TEXT DEFAULT 'scheduled' CHECK(status IN ('scheduled', 'taken', 'missed', 'skipped')),
    phase INTEGER NOT NULL,
    character_response TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**character_interactions**:
```sql
CREATE TABLE character_interactions (
    interaction_id INTEGER PRIMARY KEY AUTOINCREMENT,
    course_id INTEGER REFERENCES treatment_courses(course_id),
    character_name TEXT NOT NULL,
    interaction_type TEXT CHECK(interaction_type IN ('greeting', 'reminder', 'encouragement', 'warning', 'farewell')),
    message_text TEXT NOT NULL,
    user_response TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### Связи между таблицами

```
users (1) ──→ (N) treatment_courses
treatment_courses (1) ──→ (N) tabex_logs
treatment_courses (1) ──→ (N) character_interactions
```

## Пошаговый план реализации

### ✅ Этап 1: Подготовка инфраструктуры (ВЫПОЛНЕН)

**Реализовано**:
1. ✅ Создание структуры проекта согласно архитектуре
2. ✅ Настройка виртуального окружения Python
3. ✅ Установка зависимостей (python-telegram-bot, aiosqlite, python-dotenv)
4. ✅ Создание файла конфигурации с токеном бота
5. ✅ Инициализация Git-репозитория

**Результат**: ✅ Готовая структура проекта с настроенным окружением.

### ✅ Этап 2: Базовая инфраструктура бота (ВЫПОЛНЕН)

**Реализовано**:
1. ✅ Создание основного класса бота в `core/bot.py`
2. ✅ Реализация базовых обработчиков команд (`/start`, `/help`, `/stats`)
3. ✅ Настройка логирования приложения
4. ✅ Создание main.py для запуска бота
5. ✅ Тестирование подключения к Telegram API
6. ✅ Обработка ввода времени первого приёма

**Результат**: ✅ Работающий бот с базовой функциональностью от капитана Ваймса.

**Примечание**: Текущая реализация использует только персонаж Ваймса. Необходимо рефакторить под новую концепцию с множественными персонажами и Гаспода как стартового персонажа.

### Этап 3: База данных и гендерная система (75 минут)

**Задачи**:
1. Создание схемы SQLite базы данных с поддержкой гендера
2. Реализация классов-моделей (User с gender, Treatment, TabexLog, CharacterInteraction)
3. Создание репозиториев для работы с данными
4. Реализация миграций базы данных
5. Создание методов для CRUD операций
6. Добавление гендерного выбора в команду `/start`
7. Рефакторинг команды `/start` под Гаспода вместо Ваймса

**Результат**: Полнофункциональная система работы с данными и гендерной дифференциацией.

### Этап 4: Система персонажей Пратчетта (120 минут)

**Задачи**:
1. Создание базового класса персонажей в `core/characters/base_character.py`
2. Реализация всех персонажей с их уникальными стилями речи:
   - Гаспод (арест и передача)
   - Шнобби и Колон (дни 1-12)
   - Ангва (дни 13-16)
   - Моркоу (дни 17-20)
   - Ваймс (дни 21-25)
   - Витинари (финальная аудиенция)
   - СМЕРТЬ (сценарий неудачи)
3. Создание CharacterService для управления персонажами
4. Реализация гендерно-зависимых текстов для каждого персонажа
5. Создание JSON-файла с репликами персонажей

**Результат**: Полная система персонажей с уникальными стилями общения.

### Этап 5: Система фаз лечения Табекс (90 минут)

**Задачи**:
1. Создание конфигурации фаз лечения в `config/tabex_phases.py`:
   - Фаза 1: дни 1-3, каждые 2 часа, 6 таблеток/день
   - Фаза 2: дни 4-12, каждые 2.5 часа, 5 таблеток/день + отказ от курения на 5-й день
   - Фаза 3: дни 13-16, каждые 3 часа, 4 таблетки/день
   - Фаза 4: дни 17-20, каждые 5 часов, 3 таблетки/день
   - Фаза 5: дни 21-25, 1-2 таблетки/день
2. Реализация TreatmentPhaseManager для управления переходами между фазами
3. Создание ScheduleService с расчётом времени приёма по фазам
4. Интеграция смены персонажей при переходе между фазами
5. Реализация проверки критического 5-го дня (полный отказ от курения)

**Результат**: Полнофункциональная медицинская система фаз лечения Табекс.

### Этап 6: Система напоминаний и уведомлений (120 минут)

**Задачи**:
1. Реализация ReminderService для отправки напоминаний от персонажей
2. Создание системы asyncio-планировщика для точных уведомлений
3. Интеграция персонализированных напоминаний (текущий персонаж + гендер)
4. Реализация escalation при пропуске приёма
5. Создание inline-клавиатур для подтверждения приёма таблеток
6. Обработка callback'ов подтверждения от разных персонажей
7. Система поощрений и предупреждений от персонажей

**Результат**: Полнофункциональная система умных напоминаний с персонажами.

### Этап 7: Интеграция цитат и пользовательский интерфейс (90 минут)

**Задачи**:
1. Создание JSON-файла с цитатами Пратчетта по персонажам
2. Реализация QuoteService с контекстуальным выбором цитат
3. Интеграция цитат в сообщения персонажей
4. Создание команд `/stats`, `/pause`, `/resume`
5. Добавление команды `/quote` для получения случайной цитаты
6. Реализация системы достижений и прогресса
7. Создание финального диалога с Витинари

**Результат**: Полный пользовательский интерфейс с интегрированными цитатами и геймификацией.

### Этап 8: Тестирование и полировка (60 минут)

**Задачи**:
1. Полное тестирование всех сценариев (успешное и неуспешное лечение)
2. Проверка корректности смены персонажей по фазам
3. Тестирование гендерно-зависимых текстов
4. Финальная проверка расчёта расписания приёма
5. Тестирование системы напоминаний и escalation
6. Оптимизация производительности и устранение багов

**Результат**: Полностью протестированная и отлаженная система.

### Этап 9: Деплой и мониторинг (30 минут)

**Задачи**:
1. Создание скрипта для автозапуска бота
2. Настройка системного сервиса (systemd на Linux или Service на Windows)
3. Создание простой системы мониторинга работы бота
4. Настройка ротации логов и резервного копирования БД
5. Документирование процедур эксплуатации

**Результат**: Автономно работающий production-бот с мониторингом.

## Технические детали реализации

### Система персонажей и нарратива

**Character-Driven Architecture**:
```python
class BaseCharacter:
    def get_greeting_message(self, user_gender: str) -> str
    def get_reminder_message(self, user_gender: str, dose_number: int) -> str
    def get_encouragement_message(self, user_gender: str, progress: int) -> str
    def get_warning_message(self, user_gender: str, missed_doses: int) -> str
    def get_farewell_message(self, user_gender: str) -> str
```

**Гендерно-зависимая генерация текстов**:
- Персонажи реагируют по-разному на пользователей мужского и женского пола
- Ангва может проявлять "волчьи" инстинкты в зависимости от гендера пользователя
- Моркоу демонстрирует различную степень галантности
- СМЕРТЬ остается гендерно-нейтральным (в своём буквальном стиле)

### Система планирования напоминаний Табекс

**Алгоритм расчёта времени приёма по фазам**:
```python
TABEX_PHASES = {
    1: {"days": (1, 3), "interval_hours": 2, "doses_per_day": 6},
    2: {"days": (4, 12), "interval_hours": 2.5, "doses_per_day": 5},
    3: {"days": (13, 16), "interval_hours": 3, "doses_per_day": 4},
    4: {"days": (17, 20), "interval_hours": 5, "doses_per_day": 3},
    5: {"days": (21, 25), "interval_hours": None, "doses_per_day": "1-2"}
}
```

**Критический 5-й день**:
- Автоматическая проверка полного отказа от курения
- Специальные сообщения от Шнобби и Колона
- В случае срыва → активация сценария СМЕРТИ

### Система переходов между персонажами

**Сценарий успешного лечения**:
```
ГАСПОД → ШНОББИ & КОЛОН → АНГВА → МОРКОУ → ВАЙМС → ВИТИНАРИ
(арест)   (дни 1-12)      (13-16)  (17-20)  (21-25)  (финал)
```

**Сценарий неудачи** (пропуски/срыв на 5-й день):
```
ЛЮБОЙ_ПЕРСОНАЖ → СМЕРТЬ → возврат через 2-3 месяца
```

### Обработка ошибок и отказоустойчивость

**Критические сценарии**:
- Потеря соединения с Telegram API
- Недоступность базы данных во время критических напоминаний
- Системные сбои во время переходов между персонажами
- Некорректные пользовательские данные (гендер, время)

**Стратегии восстановления**:
- Автоматический retry для API-запросов с экспоненциальным backoff
- Локальное кэширование состояния персонажей и фаз лечения
- Система аварийных уведомлений через fallback-персонажа (Ваймс)
- Graceful degradation с переключением на упрощенные тексты

### Геймификация и мотивация

**Система прогресса**:
- Визуальное отображение прохождения "карьерной лестницы" в страже
- Достижения за безупречное соблюдение режима
- Специальные награды от персонажей за важные вехи
- Финальное "раскрытие карт" от Витинари как кульминация

Данная архитектура сочетает медицинскую точность системы напоминаний с развлекательным нарративом мира Плоского мира, создавая уникальный пользовательский опыт для мотивации к отказу от курения.